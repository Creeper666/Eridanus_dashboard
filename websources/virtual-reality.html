<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>对话</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="./assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="./assets/css/nucleo-svg.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
  <link id="pagestyle" href="./assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <link href="./assets/css/viewer.min.css" rel="stylesheet" />
  <style>
    .chat-container {
      height: calc(100vh - 250px);
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 70%;
      position: relative;
    }

    .user-message {
      background-color: #4CAF50;
      color: white;
      align-self: flex-end;
    }

    .server-message {
      background-color: #f0f0f0;
      color: black;
      align-self: flex-start;
    }

    .input-area {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #ddd;
    }

    .input-area input {
      flex-grow: 1;
      margin-right: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.25rem;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-100 d-flex">
  <!-- 侧边栏 -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 my-2"
    id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
        aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand px-4 py-3 m-0" href="" target="_blank">
        <img src="./assets/img/logo.svg" class="navbar-brand-img" width="26" height="26" alt="main_logo">
        <span class="ms-1 text-sm">Eridanus</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">功能</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./dashboard.html">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">总览</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./yaml-editor.html">
            <i class="material-symbols-rounded opacity-5">edit_note</i>
            <span class="nav-link-text ms-1">编辑配置文件</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-dark text-white" href="./virtual-reality.html">
            <i class="material-symbols-rounded opacity-5">forum</i>
            <span class="nav-link-text ms-1">对话</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./setup.html">
            <i class="material-symbols-rounded opacity-5">notifications</i>
            <span class="nav-link-text ms-1">搭建</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">TOOLS</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./profile.html">
            <i class="material-symbols-rounded opacity-5">person</i>
            <span class="nav-link-text ms-1">启动</span>
          </a>
        </li>
      </ul>
    </div>
    <div class="sidenav-footer position-absolute w-100 bottom-0 ">
      <div class="mx-3">
        <a class="btn btn-outline-dark mt-4 w-100" href="https://eridanus-doc.netlify.app/" type="button"
          target="_blank">
          <i class="material-symbols-rounded" style="margin: 0 3px 0 0">open_in_new</i>
          Eridanus文档</a>
      </div>
  </aside>

  <!-- 主内容区 -->
  <div class="flex-grow-1" style="margin-left: 250px; width: calc(100% - 250px);">
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur"
      data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">对话</li>
          </ol>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group input-group-outline">
              <label class="form-label">Type here...</label>
              <input type="text" class="form-control">
            </div>
          </div>
          <ul class="navbar-nav d-flex align-items-center  justify-content-end">
            <li class="mt-1 github-star">
              <a class="github-button" href="https://github.com/avilliai/Eridanus" data-icon="octicon-star"
                data-size="large" data-show-count="true" aria-label="Star Eridanus on GitHub" target="_blank">Star</a>
            </li>
            <li class="nav-item d-xl-none pb-2 ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0">
                <i class="material-symbols-rounded fixed-plugin-button-nav">settings</i>
              </a>
            </li>
            <li class="nav-item pe-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body font-weight-bold px-0" onclick="changeTheme()">
                <i class="material-symbols-rounded">brightness_4</i>
              </a>
            </li>
            <li class="nav-item dropdown pe-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="material-symbols-rounded">notifications</i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="./assets/img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New message</span> from Laur
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          13 minutes ago
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="./assets/img/small-logos/logo-spotify.svg"
                          class="avatar avatar-sm bg-gradient-dark  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New album</span> by Travis Scott
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          1 day
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background"
                                    d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z"
                                    opacity="0.593633743"></path>
                                  <path class="color-background"
                                    d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z">
                                  </path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          Payment successfully completed
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          2 days
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a href="./pages/sign-in.html" class="nav-link text-body font-weight-bold px-0">
                <i class="material-symbols-rounded">account_circle</i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card my-4">
            <div class="card-body px-0 pb-2">
              <div class="chat-container" id="chatContainer"></div>
              <div class="input-area d-flex align-items-center">
                <input type="text" id="messageInput" placeholder="Type your message..." class="form-control">
                <input type="file" id="fileInput" accept="image/*,video/*,audio/*,.pdf,.txt" style="display: none;" multiple>
                <button onclick="document.getElementById('fileInput').click()" class="btn btn-light mx-2">
                    Upload
                </button>
                <button onclick="sendMessage()" class="btn bg-gradient-primary">Send</button>
            </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let ws;
    function connectWebSocket() {
      ws = new WebSocket("ws://127.0.0.1:5008");
      ws.onopen = () => addServerMessage("WebSocket Connected!");
      ws.onmessage = (event) => handleServerMessage(event.data);
      ws.onclose = () => setTimeout(connectWebSocket, 5000);
      ws.onerror = (error) => addServerMessage(`WebSocket Error: ${error.message || 'Unknown error'}`);
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (message && ws && ws.readyState === WebSocket.OPEN) {
        addUserMessage(message);
        ws.send(JSON.stringify([{ type: "text", data: { text: message } }]));
        input.value = "";
      }
    }

    function addUserMessage(msg) {
      console.log("添加用户消息:", msg);
      const chatContainer = document.getElementById("chatContainer");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "user-message");


      if (typeof msg === "string") {
        if (msg==="") return;
        messageDiv.textContent = msg;
      } else if (msg.type === "text") {
        if (msg.data.text==="") return;
        messageDiv.textContent = msg.data.text;
      } else if (msg.type === "image" && msg.data?.file) {
        const img = document.createElement("img");
        img.src = msg.data.url;
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", "user-message");
        messageDiv.style.maxWidth = "40%"; // 让 div 自适应但不太宽

        img.style.width = "100%"; // 让图片填充父容器
        img.style.borderRadius = "8px"; // 让图片更美观

        img.style.cursor = "pointer";//鼠标放上去变点击
        new Viewer(img,{url: 'src'});
        messageDiv.appendChild(img);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

      } else if (msg.type === "video" && msg.data?.file) {
        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", "user-message");

        const video = document.createElement("video");
        video.src = msg.data.url;
        video.controls = true;
        video.style.maxWidth = "100%";
        video.style.borderRadius = "8px";

        messageDiv.appendChild(video);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } else if (msg.type === "record" || msg.type === "audio" && msg.data?.file) {

          const chatContainer = document.getElementById("chatContainer");
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("message", "user-message");

          const audio = document.createElement("audio");
          audio.src = audioPath;
          audio.controls = true;

          messageDiv.appendChild(audio);
          chatContainer.appendChild(messageDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
      } else if (msg.type === "file" && msg.data?.file) {
        const filePath = msg.data.url;
        const fileName = decodeURIComponent(filePath.split('/').pop());
        const link = document.createElement("span");
        link.textContent = fileName;
        link.style.color = "blue";
        link.style.textDecoration = "underline";
        link.style.cursor = "pointer";
        link.addEventListener("click", () => {
          navigator.clipboard.writeText(filePath).then(() => {
            alert("文件路径已复制，请手动粘贴到浏览器打开：\n\n" + filePath);
          }).catch(err => {
            console.error("无法复制路径：", err);
            alert("请手动复制文件路径：\n\n" + filePath);
          });
        });
        messageDiv.appendChild(link);
      }

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    async function processMessage(msg) {
      if (!msg || !msg.type) {
        console.warn("无效消息:", msg);
        return;
      }
      let fileExtension = "";
      if (msg.data?.file) {
        let filePath = msg.data.file;
        fileExtension = filePath.split('.').pop().toLowerCase(); // 获取文件后缀
      }
      // 处理 node（递归解析）
      if (msg.type === "node" && msg.data && msg.data.content) {
        console.log("处理 node 消息:", msg.data);
        for (const content of msg.data.content) {
          await processMessage(content);
        }
        return;
      }

      // 处理文本消息
      if (msg.type === "text" && msg.data?.text?.trim()) {
        console.log("添加文本消息:", msg.data.text);
        addServerMessage(msg.data.text);
        return;
      }
      if (msg.type === "music"){
        console.log("添加音乐消息:", msg.data.title);
        let audio_url = msg.data.audio;
        addAudioMessage(audio_url);
        return;
      }

  // 处理图片消息
      if (msg.type === "image" && msg.data?.file) {

        let imageUrl = msg.data.file;
        if (imageUrl.startsWith("file://")) {
          imageUrl = await convertFileToBase64(imageUrl);
          if (!imageUrl) return;
        }
        console.log("添加图片消息:", imageUrl);
        addImageMessage(imageUrl);
        return;
      }
      if (msg.type === "video" || fileExtension === "mp4") {
        let videoPath = msg.data.file;
        if (videoPath.startsWith("file://")) {
          videoPath = await convertFileToBase64(videoPath); // 转换为 Base64
          if (!videoPath) return;
        }
        console.log("添加视频消息:", videoPath);
        addVideoMessage(videoPath);
        return;
      }
      // 处理音频消息
      if (msg.type === "record" || ["mp3", "wav"].includes(fileExtension)) {
        let audioPath = msg.data.file;
        if (audioPath.startsWith("file://")) {
          audioPath = await convertFileToBase64(audioPath); // 转换为 Base64
          if (!audioPath) return;
        }
        console.log("添加音频消息:", audioPath);
        addAudioMessage(audioPath);
        return;
      }
      if (msg.type === "file") {
        let filePath = msg.data.file;

        // 处理 Windows 和 Linux 的 file:// 格式
        if (filePath.startsWith("file://")) {
            filePath = filePath.replace("file:///", "").replace("file://", "");
        }

        const fileName = decodeURIComponent(filePath.split('/').pop()); // 解析文件名

        const link = document.createElement("span");
        link.textContent = fileName; // 显示文件名
        link.style.color = "blue";
        link.style.textDecoration = "underline";
        link.style.cursor = "pointer"; // 让它看起来像个可点击的链接

        // 点击时，弹出提示框，并复制到剪贴板
        link.addEventListener("click", () => {
            navigator.clipboard.writeText(filePath).then(() => {
                alert("文件路径已复制，请手动粘贴到浏览器打开：\n\n" + filePath);
            }).catch(err => {
                console.error("无法复制路径：", err);
                alert("请手动复制文件路径：\n\n" + filePath);
            });
        });

        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", "server-message");

        messageDiv.appendChild(link);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

    }
    console.warn("未知消息类型:", msg);
  }

   async function handleServerMessage(rawData) {
    try {
      const data = JSON.parse(rawData);

      if (!data.message || !data.message.params) {
        console.warn("收到无效消息:", data);
        return;
      }

      let messages = data.message.params.messages || data.message.params.message; // 兼容 node 和普通消息
      if (!Array.isArray(messages)) {
        console.warn("消息格式错误:", messages);
        return;
      }

      for (const msg of messages) {
        await processMessage(msg);
      }
    } catch (e) {
      console.error("解析服务器消息失败:", e);
      addServerMessage("[Invalid message format]");
    }
  }






    function addServerMessage(message) {
    if (!message.trim()) return;  // 如果 message 为空或仅包含空格，则不显示

    const chatContainer = document.getElementById("chatContainer");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", "server-message");
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    async function convertFileToBase64(filePath) {
    try {
        const response = await fetch("http://127.0.0.1:5007/api/file2base64", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: filePath })
        });

        const data = await response.json();
        if (data.base64) {
            return data.base64;  // 返回 base64 数据
        } else {
            console.error("Error:", data.error);
            return null;
        }
    } catch (error) {
        console.error("Request failed:", error);
        return null;
    }
}
    function addVideoMessage(videoPath) {
      const chatContainer = document.getElementById("chatContainer");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "server-message");

      const video = document.createElement("video");
      video.src = videoPath;
      video.controls = true;
      video.style.maxWidth = "100%";
      video.style.borderRadius = "8px";

      messageDiv.appendChild(video);
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 处理音频消息（嵌入音频）
    function addAudioMessage(audioPath) {
      const chatContainer = document.getElementById("chatContainer");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "server-message");

      const audio = document.createElement("audio");
      audio.src = audioPath;
      audio.controls = true;

      messageDiv.appendChild(audio);
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function addImageMessage(imagePath) {
    if (imagePath.startsWith("file://")) {
        imagePath = await convertFileToBase64(imagePath);
        if (!imagePath) return;  // 如果转换失败，直接返回
    }

    const chatContainer = document.getElementById("chatContainer");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", "server-message");
    messageDiv.style.maxWidth = "20%"; // 让 div 自适应但不太宽

    const img = document.createElement("img");
    img.src = imagePath;
    img.style.width = "100%"; // 让图片填充父容器
    img.style.borderRadius = "8px"; // 让图片更美观
    img.style.cursor = "pointer";//鼠标放上去变点击
    new Viewer(img,{url: 'src'});
    messageDiv.appendChild(img);
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    document.getElementById("fileInput").addEventListener("change", function (event) {
      const files = event.target.files;
      console.log("选择的文件:", files);
      if (files.length > 0) {
        for (const file of files) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const base64Data = e.target.result.split(",")[1]; // 获取 Base64 数据
            const mimeType = file.type; // 直接获取文件 MIME 类型
            const fileType = file.type.split("/")[0]; // 获取文件类别（image, video, audio, etc.）

            let messageData;
            if (fileType === "image") {
              messageData = { type: fileType, data: { url: `data:${mimeType};base64,${base64Data}`, file: file.name } };
            } else if (fileType === "video" || fileType === "audio") {
              messageData = { type: fileType, data: { file: `data:${mimeType};base64,${base64Data}` } };
            } else {
              messageData = { type: fileType, data: { name: file.name, content: `data:${mimeType};base64,${base64Data}` } };
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify([messageData]));
              addUserMessage(messageData);
            }
          };
          reader.readAsDataURL(file); // 读取文件内容为 Base64
        }
      }
    });
    document.addEventListener("DOMContentLoaded", connectWebSocket);
    document.getElementById('messageInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        sendMessage();
        event.preventDefault();
      }
    });
  </script>
  <script src="./assets/js/core/popper.min.js"></script>
  <script src="./assets/js/core/bootstrap.min.js"></script>
  <script src="./assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="./assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="./assets/js/material-dashboard.js?v=3.2.0"></script>
  <script src="./assets/js/viewer.min.js"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</body>
</html>