<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/favicon.png">
  <title>Material Dashboard 3 - Chat</title>
  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <!-- Nucleo Icons -->
  <link href="./assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="./assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <!-- CSS Files -->
  <link id="pagestyle" href="./assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <style>
    .chat-container {
      height: calc(100vh - 250px); /* Adjust based on your navbar/footer height */
      overflow-y: scroll;
      padding: 1rem;
      display: flex;
      flex-direction: column;

    }

    .message {
      margin-bottom: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 70%;
      position: relative; /* For triangle */
    }

    .user-message {
      background-color: #4CAF50; /* Or any color you prefer */
      color: white;
      align-self: flex-end;

    }

      /* Triangle for user message */
    .user-message::before {
        content: '';
        position: absolute;
        right: -10px; /* Adjust as needed */
        top: 50%;
        transform: translateY(-50%);
        border-width: 10px;
        border-style: solid;
        border-color: transparent transparent transparent #4CAF50; /* Same color as user-message */

    }
      .user-message.typing::after {
          content: '...'; /* Typing indicator */
          animation: typing-blink 1s infinite;
          color: white; /* Adjust color as needed */
          font-size: 1.2em;
      }

    .server-message {
      background-color: #f0f0f0;
      color: black;
      align-self: flex-start;
    }
      /* Triangle for server message */
    .server-message::before {
        content: '';
        position: absolute;
        left: -10px; /* Adjust as needed */
        top: 50%;
        transform: translateY(-50%);
        border-width: 10px;
        border-style: solid;
        border-color: transparent #f0f0f0 transparent transparent; /* Match server-message bg */

    }
     .server-message.typing::after {
        content: '...';
        animation: typing-blink 1s infinite;
         color:black;
    }

    .input-area {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #ddd;
    }

    .input-area input {
      flex-grow: 1;
      margin-right: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.25rem;
      border: 1px solid #ccc;
    }

    .input-area button {
        /* Keep your button styles */
        padding: 0.5rem 1rem;
    }
    /* Typing animation */
      @keyframes typing-blink {
          0%, 50% {
              opacity: 1;
          }

          51%, 100% {
              opacity: 0;
          }
      }

  </style>
</head>

<body class="g-sidenav-show bg-gray-100">

  <!-- Navbar (Keep this simplified for chat) -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">

        <div class="container-fluid py-1 px-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                    <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
                    <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Chat</li>
                </ol>
                <h6 class="font-weight-bolder mb-0">Chat Interface</h6>
            </nav>
            <!--  add a refresh button-->
            <ul class="navbar-nav  justify-content-end">
                <li class="nav-item d-flex align-items-center">
                    <a href="javascript:;" class="nav-link text-body font-weight-bold px-0" onclick="location.reload();">
                        <i class="material-symbols-rounded">refresh</i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
  <!-- End Navbar -->
 <div class="container-fluid py-4">
    <div class="row">
      <div class="col-12">
        <div class="card my-4">
          <div class="card-body px-0 pb-2">
            <div class="chat-container" id="chatContainer">
              <!-- Messages will be appended here -->
            </div>
            <div class="input-area">
              <input type="text" id="messageInput" placeholder="Type your message..." class="form-control">
              <button onclick="sendMessage()" class="btn bg-gradient-primary">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
 </div>
 <footer class="footer py-4  ">
        <div class="container-fluid">
            <div class="row align-items-center justify-content-lg-between">
                <div class="col-lg-6 mb-lg-0 mb-4">
                    <div class="copyright text-center text-sm text-muted text-lg-start">
                        Â© <script>
                            document.write(new Date().getFullYear())
                        </script>,
                        made with <i class="fa fa-heart"></i> by
                        <a href="https://www.creative-tim.com" class="font-weight-bold" target="_blank">Creative Tim</a>
                        for a better web.
                    </div>
                </div>
                <div class="col-lg-6">
                    <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com" class="nav-link text-muted" target="_blank">Creative Tim</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com/presentation" class="nav-link text-muted" target="_blank">About Us</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com/blog" class="nav-link text-muted" target="_blank">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted" target="_blank">License</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>


  <!--   Core JS Files   -->
  <script src="./assets/js/core/popper.min.js"></script>
  <script src="./assets/js/core/bootstrap.min.js"></script>
  <script src="./assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="./assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <!--  <script src="./assets/js/material-dashboard.min.js?v=3.2.0"></script>  Removed this to avoid conflicts -->
  <script>
    let ws;

    function connectWebSocket() {
      // Use location.hostname to get the current host
      ws = new WebSocket(`ws://127.0.0.1:8765`); // Or your specific port


      ws.onopen = () => {
        console.log("WebSocket connection opened");
        addServerMessage("WebSocket Connected!"); // Notify user of connection
      };

      ws.onmessage = (event) => {
        // console.log("Message from server ", event.data);
        addServerMessage(event.data); // Display received message
          removeTypingIndicator(false);
      };

      ws.onclose = () => {
        console.log("WebSocket connection closed");
        addServerMessage("WebSocket Disconnected!"); // Notify of disconnection

        // Attempt to reconnect after a delay (optional, but good practice)
        setTimeout(connectWebSocket, 5000); // Reconnect after 5 seconds
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        addServerMessage(`WebSocket Error: ${error.message || 'Unknown error'}`);
      };
    }

     function addTypingIndicator(isUser) {
         const chatContainer = document.getElementById("chatContainer");
         const typingDiv = document.createElement("div");
         typingDiv.classList.add("message", isUser ? "user-message" : "server-message", "typing");
         typingDiv.id = isUser ? "user-typing" : "server-typing";  // Add an ID for easy removal
         chatContainer.appendChild(typingDiv);
         chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom

      }
      function removeTypingIndicator(isUser) {
          const typingDiv = document.getElementById(isUser ? "user-typing" : "server-typing");
          if (typingDiv) {
              typingDiv.remove();
          }
      }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value;

      if (message.trim() === "") return; // Prevent sending empty messages

      if (ws && ws.readyState === WebSocket.OPEN) {
        addUserMessage(message);  // Show user's message immediately
          addTypingIndicator(false); // Show typing indicator
        ws.send(message);
        input.value = ""; // Clear input
      } else {
        console.warn("WebSocket is not open.  Cannot send message.");
        addServerMessage("Cannot send message, WebSocket is not connected.");
      }
        input.focus();

    }
      function addUserMessage(message) {
        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", "user-message");
        messageDiv.textContent = message;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }


    function addServerMessage(message) {
      const chatContainer = document.getElementById("chatContainer");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "server-message");
      messageDiv.textContent = message;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom
    }

    // Connect on page load:
    document.addEventListener("DOMContentLoaded", () => {
      connectWebSocket();

       // Prevent form submission (if you have a form)
        const form = document.querySelector('form'); // Replace 'form' with your form's selector
        if(form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
             });
        }


        // Send message on Enter key press
        document.getElementById('messageInput').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
                event.preventDefault(); // Prevent default newline behavior in textarea, if applicable
            }
        });
    });

      // Call connectWebSocket on page load, or when you need to establish the connection
  </script>
</body>

</html>