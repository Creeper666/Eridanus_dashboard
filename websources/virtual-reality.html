<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Material Dashboard 3 - Chat</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="./assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="./assets/css/nucleo-svg.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
  <link id="pagestyle" href="./assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <style>
    .chat-container {
      height: calc(100vh - 250px);
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      max-width: 70%;
      position: relative;
    }

    .user-message {
      background-color: #4CAF50;
      color: white;
      align-self: flex-end;
    }

    .server-message {
      background-color: #f0f0f0;
      color: black;
      align-self: flex-start;
    }

    .input-area {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #ddd;
    }

    .input-area input {
      flex-grow: 1;
      margin-right: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.25rem;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-100">
  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl">
    <div class="container-fluid py-1 px-3">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0">
          <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
          <li class="breadcrumb-item text-sm text-dark active">Chat</li>
        </ol>
        <h6 class="font-weight-bolder mb-0">Chat Interface</h6>
      </nav>
      <ul class="navbar-nav justify-content-end">
        <li class="nav-item d-flex align-items-center">
          <a href="javascript:;" class="nav-link text-body font-weight-bold" onclick="location.reload();">
            <i class="material-symbols-rounded">refresh</i>
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <div class="container-fluid py-4">
    <div class="row">
      <div class="col-12">
        <div class="card my-4">
          <div class="card-body px-0 pb-2">
            <div class="chat-container" id="chatContainer"></div>
            <div class="input-area">
              <input type="text" id="messageInput" placeholder="Type your message..." class="form-control">
              <input type="file" id="imageInput" accept="image/*" style="display: none;">
              <button onclick="sendMessage()" class="btn bg-gradient-primary">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let ws;
    function connectWebSocket() {
      ws = new WebSocket("ws://127.0.0.1:5008");
      ws.onopen = () => addServerMessage("WebSocket Connected!");
      ws.onmessage = (event) => handleServerMessage(event.data);
      ws.onclose = () => setTimeout(connectWebSocket, 5000);
      ws.onerror = (error) => addServerMessage(`WebSocket Error: ${error.message || 'Unknown error'}`);
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (message && ws && ws.readyState === WebSocket.OPEN) {
        addUserMessage(message);
        ws.send(JSON.stringify([{ type: "text", data: { text: message } }]));
        input.value = "";
      }
    }

    function addUserMessage(message) {
      const chatContainer = document.getElementById("chatContainer");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "user-message");
      messageDiv.textContent = message;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    async function processMessage(msg) {
  if (!msg || !msg.type) {
    console.warn("无效消息:", msg);
    return;
  }

  // 处理 node（递归解析）
  if (msg.type === "node" && msg.data && msg.data.content) {
    console.log("处理 node 消息:", msg.data);
    for (const content of msg.data.content) {
      await processMessage(content);
    }
    return;
  }

  // 处理文本消息
  if (msg.type === "text" && msg.data?.text?.trim()) {
    console.log("添加文本消息:", msg.data.text);
    addServerMessage(msg.data.text);
    return;
  }

  // 处理图片消息
  if (msg.type === "image" && msg.data?.file) {
    let imageUrl = msg.data.file;
    if (imageUrl.startsWith("file://")) {
      imageUrl = await convertFileToBase64(imageUrl);
      if (!imageUrl) return;
    }
    console.log("添加图片消息:", imageUrl);
    addImageMessage(imageUrl);
    return;
  }

  console.warn("未知消息类型:", msg);
}

   async function handleServerMessage(rawData) {
  try {
    const data = JSON.parse(rawData);

    if (!data.message || !data.message.params) {
      console.warn("收到无效消息:", data);
      return;
    }

    let messages = data.message.params.messages || data.message.params.message; // 兼容 node 和普通消息
    if (!Array.isArray(messages)) {
      console.warn("消息格式错误:", messages);
      return;
    }

    for (const msg of messages) {
      await processMessage(msg);
    }
  } catch (e) {
    console.error("解析服务器消息失败:", e);
    addServerMessage("[Invalid message format]");
  }
}






    function addServerMessage(message) {
    if (!message.trim()) return;  // 如果 message 为空或仅包含空格，则不显示

    const chatContainer = document.getElementById("chatContainer");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", "server-message");
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    async function convertFileToBase64(filePath) {
    try {
        const response = await fetch("http://127.0.0.1:5007/api/file2base64", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: filePath })
        });

        const data = await response.json();
        if (data.base64) {
            return data.base64;  // 返回 base64 数据
        } else {
            console.error("Error:", data.error);
            return null;
        }
    } catch (error) {
        console.error("Request failed:", error);
        return null;
    }
}

    async function addImageMessage(imagePath) {
    if (imagePath.startsWith("file://")) {
        imagePath = await convertFileToBase64(imagePath);
        if (!imagePath) return;  // 如果转换失败，直接返回
    }

    const chatContainer = document.getElementById("chatContainer");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", "server-message");
    messageDiv.style.maxWidth = "20%"; // 让 div 自适应但不太宽

    const img = document.createElement("img");
    img.src = imagePath;
    img.style.width = "100%"; // 让图片填充父容器
    img.style.borderRadius = "8px"; // 让图片更美观

    messageDiv.appendChild(img);
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    }



    document.addEventListener("DOMContentLoaded", connectWebSocket);
    document.getElementById('messageInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        sendMessage();
        event.preventDefault();
      }
    });
  </script>
</body>
</html>